<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="com.kingbo401.acl.dao.UserPermissionRefDAO"> 
	<insert id="batchCreate" parameterType="list">
		insert into user_permission_ref(user_id,permission_id,tenant,status,effective_time,expire_time,create_time,update_time) values
		<foreach collection="list" item="item" index="index" separator="," >  
		(#{item.userId},#{item.permissionId},#{item.tenant},#{item.status},#{item.effectiveTime},#{item.expireTime},#{item.createTime},#{item.updateTime})
		</foreach>
		ON DUPLICATE KEY UPDATE update_time = now(),status = values(status),effective_time=values(effective_time),expire_time=values(expire_time)
	</insert>

	<update id="updateRefsStatus">
		update user_permission_ref set status = #{status},update_time = now() where user_id=#{userId}
		<if test = "tenant != null and tenant != ''">
			and tenant=#{tenant}
		</if>
		<if test="permissionIds != null and permissionIds.size > 0">
			and permission_id in
			<foreach collection="permissionIds" item="permissionId" open="(" separator="," close=")">
				#{permissionId}
			</foreach>
		</if>
	</update>
	
	<update id="removeRefsByPermissionId">
		update user_permission_ref set status = 0,update_time = now() where permission_id = #{permissionId}
	</update>

	<sql id="queryUserPermissionRefSubSql">
		where t1.user_id=#{userId} and t1.tenant=#{tenant} and t1.permission_id=t2.id 
		<if test="status != null">
            and t1.status = #{status},
        </if>
		<if test = "appKey != null and appKey != ''">
		    and t2.app_key=#{appKey}
		</if>
		<if test='tenant == "_t_common"'>
		    and t2.tenant='_t_common'
		</if>
		<if test='tenant != "_t_common"'>
		    and t2.tenant in ('_t_common',#{tenant})
		</if>
		<if test = "permissionKey != null and permissionKey != ''">
		    and t2.permission_key = #{permissionKey}
		</if>
		<if test = "permissionType != null and permissionType != ''">
		    and t2.type = #{permissionType}
		</if>
		<if test = "permissionId != null">
		    and t2.id = #{permissionId}
		</if>
		<if test="returnNotEffective == false">
			and	(t1.expire_time &gt;= now() or t1.expire_time is null) 
			and (t1.effective_time &lt;= now() or t1.effective_time is null)
		</if>
		and t2.status=1 and t1.status!=0
	</sql>
	
	<select id = "listUserPermissionRef"  resultType="com.kingbo401.acl.model.dto.UserPermissionRefDTO">
		select t1.*,t2.app_key,t2.tenant as permission_tenant,t2.permission_key,
		t2.type as permission_type,t2.name as permission_name,t2.description as permission_description
		from user_permission_ref t1, permission t2
		<include refid="queryUserPermissionRefSubSql" />
		<if test = "orderField != null and orderField != ''">
	       order by ${orderField} ${orderType}
	    </if>
	</select>
	
	<select id = "countUserPermissionRef"  resultType="long">
		select count(*) from user_permission_ref t1, permission t2
		<include refid="queryUserPermissionRefSubSql" />
	</select>
	
	<select id = "pageUserPermissionRef"  resultType="com.kingbo401.acl.model.dto.UserPermissionRefDTO">
		select t1.*,t2.app_key,t2.tenant as permission_tenant,t2.permission_key,
		t2.type as permission_type,t2.name as permission_name,t2.description as permission_description
		from user_permission_ref t1, permission t2
		<include refid="queryUserPermissionRefSubSql" />
		<if test = "orderField != null and orderField != ''">
	       order by ${orderField} ${orderType}
	    </if>
		limit #{offset},#{pageSize}
	</select>
	
	<select id = "hasUserUse" resultType="UserPermissionRefDO">
		select * from user_permission_ref 
		where permission_id=#{permissionId} and status!=0
		and	(expire_time &gt;= now() or expire_time is null)
		limit 1
	</select>
</mapper> 