<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kingbo401.iceacl.dao.PermissionGroupRefDAO">
	<insert id="batchCreate" parameterType="list" useGeneratedKeys="true"
		keyProperty="id">
		insert into ice_permission_group_ref (group_id,permission_id, status,
		create_time, update_time)
		values
		<foreach collection="list" separator="," item="item">
			(#{item.groupId}, #{item.permissionId},
			#{item.status},#{item.updateTime},#{item.createTime})
		</foreach>
		ON DUPLICATE KEY UPDATE update_time = now(),status = values{status}
	</insert>

	<update id="updateRefsStatus">
		update ice_permission_group_ref set status = #{status},update_time =
		now()
		where group_id = #{groupId}
		<if test="permissionIds != null and permissionIds.size > 0">
			and permission_id in
			<foreach collection="permissionIds" item="id" close=")" open="("
				separator=",">
				#{id}
			</foreach>
		</if>
	</update>

	<sql id="queryPermissionSubSql">
		where t1.status != 0 and t2.status = 1 and t1.group_id = #{groupId}
		and t1.permission_id=t2.id
		<if test="status != null">
			and t1.status = #{status},
		</if>
		<if test="permissionAppKey != null and permissionAppKey != ''">
			and t2.app_key=#{permissionAppKey}
		</if>
		<if test="permissionType != null and permissionType != ''">
			and t2.permission_type=#{permissionType}
		</if>
		<if test="tag1 != null and tag1 != ''">
			and t2.tag1=#{tag1}
		</if>
	</sql>

	<select id="listPermission" resultType="PermissionDO">
		select t2.* from ice_permission_group_ref t1,ice_permission t2
		<include refid="queryPermissionSubSql" />
		<if test="orderField != null and orderField != ''">
			order by ${orderField} ${orderType}
		</if>
	</select>

	<select id="pagePermission" resultType="PermissionDO">
		select t2.* from ice_permission_group_ref t1,ice_permission t2
		<include refid="queryPermissionSubSql" />
		<if test="orderField != null and orderField != ''">
			order by ${orderField} ${orderType}
		</if>
		limit #{offset},#{pageSize}
	</select>

	<select id="countPermission" resultType="long">
		select count(t2.*) from ice_permission_group_ref t1,ice_permission t2
		<include refid="queryPermissionSubSql" />
	</select>
</mapper>